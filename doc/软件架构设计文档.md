# 视频压缩工具 - 软件架构设计文档 (SAD)

**版本**: 1.0
**日期**: 2026-01-18
**项目名称**: Video Compressor (视频压缩工具)

---

## 1. 文档概述

### 1.1 目的
本文档描述视频压缩工具的软件架构设计，包括系统分解、模块划分、接口定义和设计决策，为开发团队提供架构层面的指导。

### 1.2 范围
涵盖系统的整体架构、分层设计、模块交互、技术选型和部署架构。

### 1.3 参考文档
- 软件需求规格说明书 v1.0

---

## 2. 架构概述

### 2.1 架构风格
本系统采用 **分层架构 (Layered Architecture)** 结合 **事件驱动架构 (Event-Driven Architecture)**：

- **分层架构**: UI层、业务逻辑层、外部接口层清晰分离
- **事件驱动**: 使用 Qt 信号槽机制实现组件间松耦合通信

### 2.2 架构视图

```
┌────────────────────────────────────────────────────────────────────┐
│                        表现层 (Presentation Layer)                  │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────────────────┐  │
│  │ MainWindow   │  │ FileListWidget│  │ SettingsPanel           │  │
│  │ (主窗口)     │  │ (文件列表)    │  │ (设置面板)              │  │
│  └──────────────┘  └──────────────┘  └──────────────────────────┘  │
│  ┌──────────────┐                                                   │
│  │ DropZone     │                                                   │
│  │ (拖拽区域)   │                                                   │
│  └──────────────┘                                                   │
├────────────────────────────────────────────────────────────────────┤
│                        业务逻辑层 (Business Logic Layer)            │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────────────────┐  │
│  │VideoCompressor│  │BatchCompressor│  │ CompressionSettings     │  │
│  │ (单文件压缩)  │  │ (批量压缩)   │  │ (压缩配置)              │  │
│  └──────────────┘  └──────────────┘  └──────────────────────────┘  │
│  ┌──────────────┐  ┌──────────────┐                                │
│  │ Presets      │  │ Utils        │                                │
│  │ (预设管理)   │  │ (工具函数)   │                                │
│  └──────────────┘  └──────────────┘                                │
├────────────────────────────────────────────────────────────────────┤
│                        外部接口层 (External Interface Layer)        │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │                    FFmpeg / FFprobe                           │  │
│  │                    (视频编解码引擎)                            │  │
│  └──────────────────────────────────────────────────────────────┘  │
├────────────────────────────────────────────────────────────────────┤
│                        基础设施层 (Infrastructure Layer)            │
│  ┌────────────┐  ┌────────────┐  ┌────────────┐  ┌─────────────┐  │
│  │ 文件系统   │  │ 操作系统   │  │ 进程管理   │  │ 线程管理    │  │
│  └────────────┘  └────────────┘  └────────────┘  └─────────────┘  │
└────────────────────────────────────────────────────────────────────┘
```

### 2.3 技术栈

| 层次 | 技术选型 | 说明 |
|------|----------|------|
| 界面框架 | PyQt5 | 跨平台 GUI 框架 |
| 编程语言 | Python 3.8+ | 主要开发语言 |
| 视频处理 | FFmpeg | 视频编解码核心 |
| 视频探测 | FFprobe | 视频元信息获取 |
| 进程管理 | subprocess | Python 标准库 |
| 线程管理 | threading | Python 标准库 |

---

## 3. 系统分解

### 3.1 包结构图

```
video_compressor/
│
├── main.py                      # 应用程序入口
│
├── core/                        # 核心业务模块
│   ├── __init__.py
│   ├── compressor.py            # 压缩器实现
│   ├── presets.py               # 预设配置定义
│   └── utils.py                 # 工具函数库
│
├── ui/                          # 用户界面模块
│   ├── __init__.py
│   ├── main_window.py           # 主窗口
│   ├── file_list.py             # 文件列表组件
│   └── settings.py              # 设置面板组件
│
├── docs/                        # 文档目录
│   ├── 软件需求规格说明书.md
│   ├── 软件架构设计文档.md
│   └── 详细设计文档.md
│
├── ffmpeg-.../                  # 内置 FFmpeg (可选)
│   └── bin/
│       ├── ffmpeg.exe
│       └── ffprobe.exe
│
└── requirements.txt             # Python 依赖
```

### 3.2 模块依赖图

```
                    ┌─────────────┐
                    │   main.py   │
                    └──────┬──────┘
                           │
                           ▼
                    ┌─────────────┐
                    │ MainWindow  │
                    └──────┬──────┘
                           │
           ┌───────────────┼───────────────┐
           │               │               │
           ▼               ▼               ▼
    ┌─────────────┐ ┌─────────────┐ ┌─────────────┐
    │FileListWidget│ │SettingsPanel│ │BatchCompressor│
    └──────┬──────┘ └──────┬──────┘ └──────┬──────┘
           │               │               │
           │               │               ▼
           │               │        ┌─────────────┐
           │               │        │VideoCompressor│
           │               │        └──────┬──────┘
           │               │               │
           ▼               ▼               ▼
    ┌─────────────────────────────────────────────┐
    │                  core/utils                  │
    │                  core/presets                │
    └─────────────────────┬───────────────────────┘
                          │
                          ▼
    ┌─────────────────────────────────────────────┐
    │            FFmpeg / FFprobe                  │
    └─────────────────────────────────────────────┘
```

### 3.3 模块职责

| 模块 | 职责 | 依赖 |
|------|------|------|
| main.py | 程序入口、环境初始化、高DPI设置 | ui.main_window |
| MainWindow | 主窗口管理、组件协调、事件处理 | FileListWidget, SettingsPanel, BatchCompressor |
| FileListWidget | 文件列表管理、拖拽处理 | core.utils |
| DropZone | 拖拽区域UI、文件验证 | core.utils |
| SettingsPanel | 压缩设置UI、参数收集 | core.presets |
| VideoCompressor | 单文件压缩、进度解析 | core.utils, core.presets, FFmpeg |
| BatchCompressor | 批量压缩调度、结果汇总 | VideoCompressor |
| presets | 预设定义、参数计算 | - |
| utils | 通用工具函数 | FFprobe |

---

## 4. 架构决策记录 (ADR)

### ADR-001: 选择 PyQt5 作为 GUI 框架

**状态**: 已采纳

**背景**: 需要一个跨平台的桌面 GUI 框架

**决策**: 使用 PyQt5

**理由**:
- 成熟稳定，社区活跃
- 跨平台支持良好（Windows/macOS/Linux）
- 信号槽机制适合事件驱动
- 丰富的控件库
- 良好的高 DPI 支持

**替代方案**:
- Tkinter: 功能较简单，界面不够现代
- wxPython: 社区相对较小
- PySide6: 可作为备选，许可证更友好

---

### ADR-002: 使用 FFmpeg 作为视频处理后端

**状态**: 已采纳

**背景**: 需要强大的视频编解码能力

**决策**: 通过 subprocess 调用 FFmpeg 命令行

**理由**:
- FFmpeg 是业界标准，功能全面
- 支持几乎所有视频格式和编码器
- 命令行调用简单可靠
- 便于解析进度输出

**替代方案**:
- ffmpeg-python: 封装层，增加复杂度
- moviepy: 功能有限，底层仍是 FFmpeg
- OpenCV: 不适合视频转码

---

### ADR-003: 采用多线程处理压缩任务

**状态**: 已采纳

**背景**: 压缩是耗时操作，需要避免阻塞 UI

**决策**: 在独立线程中运行 FFmpeg 进程

**理由**:
- 保持 UI 响应性
- 可以实时更新进度
- 支持取消操作

**实现**:
```python
thread = threading.Thread(target=self._compress_thread, daemon=True)
thread.start()
```

---

### ADR-004: 使用 Qt 信号槽进行组件通信

**状态**: 已采纳

**背景**: 需要实现组件间松耦合通信

**决策**: 使用 PyQt5 的 pyqtSignal 机制

**理由**:
- 线程安全
- 解耦发送者和接收者
- 支持跨线程通信
- 与 Qt 事件循环集成良好

---

### ADR-005: 内置 FFmpeg 分发

**状态**: 已采纳

**背景**: 用户可能未安装 FFmpeg

**决策**: 允许内置 FFmpeg，同时支持系统 FFmpeg

**理由**:
- 降低用户使用门槛
- 保证版本一致性
- 仍支持使用系统安装的 FFmpeg

**实现**:
```python
ffmpeg_path = os.path.join(os.path.dirname(__file__), "ffmpeg-.../bin")
if os.path.exists(ffmpeg_path):
    os.environ["PATH"] = ffmpeg_path + os.pathsep + os.environ["PATH"]
```

---

## 5. 接口设计

### 5.1 模块间接口

#### 5.1.1 MainWindow ↔ FileListWidget

```python
# 信号
files_changed = pyqtSignal()  # 文件列表变化时触发

# 方法
def get_files() -> List[str]          # 获取文件路径列表
def has_files() -> bool               # 是否有文件
def file_count() -> int               # 文件数量
def update_status(index, status)      # 更新文件状态
def add_files(file_paths: List[str])  # 添加文件
def clear_files()                     # 清空列表
```

#### 5.1.2 MainWindow ↔ SettingsPanel

```python
# 信号
settings_changed = pyqtSignal()  # 设置变化时触发

# 方法
def get_settings() -> CompressionSettings  # 获取压缩设置
def get_output_dir() -> str                # 获取输出目录
def get_suffix() -> str                    # 获取文件后缀
def should_open_folder() -> bool           # 是否打开目录
def should_play_sound() -> bool            # 是否播放提示音
def set_enabled(enabled: bool)             # 设置可用状态
```

#### 5.1.3 MainWindow ↔ BatchCompressor

```python
# 信号
file_started = pyqtSignal(int, str)              # (索引, 文件名)
file_progress = pyqtSignal(int, float)           # (索引, 进度)
file_finished = pyqtSignal(int, CompressionResult)
batch_finished = pyqtSignal(list)                # 结果列表
batch_cancelled = pyqtSignal()

# 方法
def start_batch(files, output_dir, settings, suffix)
def cancel()
def pause()
def resume()
```

### 5.2 外部接口

#### 5.2.1 FFmpeg 命令行接口

**输入**: 命令行参数
**输出**: stderr 流（包含进度信息）

**命令构建流程**:
```
CompressionSettings
        │
        ▼
  get_ffmpeg_params()
        │
        ▼
  _build_ffmpeg_command()
        │
        ▼
  ['ffmpeg', '-y', '-i', input, ...options..., output]
```

#### 5.2.2 FFprobe 接口

**调用方式**:
```python
cmd = ['ffprobe', '-v', 'quiet', '-print_format', 'json',
       '-show_format', '-show_streams', file_path]
result = subprocess.run(cmd, capture_output=True, text=True)
data = json.loads(result.stdout)
```

**返回数据结构**:
```json
{
  "format": {
    "filename": "...",
    "duration": "120.5",
    "size": "10485760",
    "bit_rate": "695000"
  },
  "streams": [
    {
      "codec_type": "video",
      "codec_name": "h264",
      "width": 1920,
      "height": 1080,
      "r_frame_rate": "30/1"
    },
    {
      "codec_type": "audio",
      "codec_name": "aac",
      "sample_rate": "48000",
      "channels": 2
    }
  ]
}
```

---

## 6. 运行时架构

### 6.1 线程模型

```
┌─────────────────────────────────────────────────────────────┐
│                        主线程 (Main Thread)                  │
│                                                              │
│  ┌──────────────┐                                           │
│  │  Qt 事件循环  │ ◄───── UI 事件、信号处理                   │
│  └──────────────┘                                           │
│         │                                                    │
│         │ 触发压缩                                           │
│         ▼                                                    │
│  ┌──────────────┐      创建      ┌──────────────────────┐   │
│  │BatchCompressor│ ───────────► │   工作线程 (daemon)   │   │
│  └──────────────┘               │                        │   │
│         ▲                       │  ┌──────────────────┐ │   │
│         │                       │  │ subprocess.Popen │ │   │
│         │ 信号                  │  │    (FFmpeg)      │ │   │
│         │                       │  └──────────────────┘ │   │
│  ┌──────────────┐               │          │            │   │
│  │  进度/结果    │ ◄────────────│──────────┘            │   │
│  │   更新UI     │               │   stdout 解析进度     │   │
│  └──────────────┘               └──────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

### 6.2 进程模型

```
┌─────────────────┐
│  Python 主进程  │
│  (video_compressor)│
└────────┬────────┘
         │
         │ subprocess.Popen
         │
         ▼
┌─────────────────┐
│   FFmpeg 进程   │
│   (子进程)      │
└─────────────────┘
```

### 6.3 信号流

```
用户操作 ──► UI组件 ──► pyqtSignal ──► 槽函数 ──► 业务逻辑
                                                    │
                                                    ▼
UI 更新 ◄── pyqtSignal ◄── 槽函数 ◄── 工作线程回调 ◄─┘
```

---

## 7. 数据架构

### 7.1 数据流图

```
┌─────────────┐     拖拽/选择      ┌─────────────┐
│  视频文件    │ ─────────────────► │  文件路径   │
└─────────────┘                    └──────┬──────┘
                                          │
                                          ▼ ffprobe
                                   ┌─────────────┐
                                   │  视频信息   │
                                   │ (video_info)│
                                   └──────┬──────┘
                                          │
┌─────────────┐                           │
│  用户设置   │ ─────────────────────────┐│
└─────────────┘                          ││
       │                                 ││
       ▼                                 ▼▼
┌─────────────┐                   ┌─────────────┐
│Compression  │ ─────────────────►│ FFmpeg 参数 │
│Settings     │  get_ffmpeg_params└──────┬──────┘
└─────────────┘                          │
                                         ▼ ffmpeg
                                  ┌─────────────┐
                                  │  输出视频   │
                                  └─────────────┘
```

### 7.2 状态管理

**文件状态机**:
```
    ┌────────┐
    │ 等待中 │ ◄─── 初始状态
    └───┬────┘
        │ 开始压缩
        ▼
    ┌────────┐
    │ 压缩中 │
    └───┬────┘
        │
   ┌────┼────┬────────┐
   │    │    │        │
   ▼    ▼    ▼        ▼
┌────┐┌────┐┌────┐ ┌────────┐
│完成││失败││取消│ │跳过    │
└────┘└────┘└────┘ └────────┘
```

**压缩器状态机**:
```
    ┌────────┐
    │  空闲  │ ◄─── 初始/完成后
    └───┬────┘
        │ start_batch()
        ▼
    ┌────────┐ ◄──────┐
    │ 运行中 │        │ 下一个文件
    └───┬────┘ ───────┘
        │
   ┌────┴────┐
   │         │
   ▼         ▼
┌────────┐ ┌────────┐
│ 已取消 │ │ 已完成 │
└────────┘ └────────┘
```

---

## 8. 部署架构

### 8.1 部署模式

```
┌─────────────────────────────────────────────────┐
│               用户计算机                         │
│                                                 │
│  ┌─────────────────────────────────────────┐   │
│  │          video_compressor/              │   │
│  │  ├── main.py                            │   │
│  │  ├── core/                              │   │
│  │  ├── ui/                                │   │
│  │  └── ffmpeg-xxx/ (可选内置)              │   │
│  └─────────────────────────────────────────┘   │
│                      │                          │
│                      ▼                          │
│  ┌─────────────────────────────────────────┐   │
│  │         Python 运行时 (3.8+)             │   │
│  │         PyQt5 库                         │   │
│  └─────────────────────────────────────────┘   │
│                      │                          │
│                      ▼                          │
│  ┌─────────────────────────────────────────┐   │
│  │         操作系统 (Windows/macOS/Linux)   │   │
│  └─────────────────────────────────────────┘   │
└─────────────────────────────────────────────────┘
```

### 8.2 打包分发方案

| 方案 | 工具 | 输出 | 适用场景 |
|------|------|------|----------|
| 源码分发 | pip | Python 包 | 开发者、已有 Python 环境 |
| Windows 可执行文件 | PyInstaller | .exe | Windows 终端用户 |
| Windows 安装包 | NSIS/Inno Setup | .msi/.exe 安装程序 | 企业部署 |
| macOS 应用 | py2app | .app | macOS 用户 |

---

## 9. 安全架构

### 9.1 安全考虑

| 风险 | 缓解措施 |
|------|----------|
| 命令注入 | 使用列表形式传递参数，不使用 shell=True |
| 路径遍历 | 验证输出路径，使用 os.path 安全处理 |
| 临时文件泄露 | 取消时清理未完成的输出文件 |
| 资源耗尽 | FFmpeg 进程可被终止，线程为 daemon 模式 |

### 9.2 安全实现示例

```python
# 安全的命令执行
cmd = ['ffmpeg', '-y', '-i', input_path, output_path]  # 列表形式
subprocess.Popen(cmd, ...)  # 不使用 shell=True

# 安全的路径处理
output_path = os.path.join(output_dir, output_name)  # 使用 os.path.join
```

---

## 10. 可扩展性设计

### 10.1 扩展点

| 扩展点 | 扩展方式 | 示例 |
|--------|----------|------|
| 新增编码器 | 扩展 VideoCodec 枚举 | 添加 VP9, AV1 |
| 新增预设 | 扩展 QUALITY_PRESETS | 添加"超高质量" |
| 新增分辨率 | 扩展 Resolution 枚举 | 添加 4K, 8K |
| 硬件加速 | 修改 _build_ffmpeg_command | 添加 NVENC 参数 |
| 新增格式 | 扩展 get_supported_formats | 添加新格式 |

### 10.2 插件化设计（未来）

```
video_compressor/
├── plugins/
│   ├── encoders/
│   │   ├── nvenc.py      # NVIDIA 硬件编码
│   │   └── qsv.py        # Intel QuickSync
│   ├── presets/
│   │   └── custom.py     # 自定义预设
│   └── formats/
│       └── webm.py       # WebM 优化
```

---

## 11. 质量属性

### 11.1 质量属性场景

| 属性 | 场景 | 响应 |
|------|------|------|
| 性能 | 压缩 1GB 视频 | 进度实时更新，UI 不卡顿 |
| 可用性 | 用户拖入视频 | 立即显示文件信息 |
| 可靠性 | 压缩中断电 | 原始文件不受影响 |
| 可维护性 | 添加新编码器 | 只需修改 presets.py |
| 可移植性 | 移植到 macOS | 修改少量平台相关代码 |

### 11.2 设计约束

- Python 3.8+ 运行时要求
- PyQt5 GPL 许可证限制
- FFmpeg GPL 许可证要求
- Windows 优先，兼顾跨平台

---

## 12. 附录

### A. 架构检查清单

- [x] 分层清晰，职责单一
- [x] 使用信号槽解耦组件
- [x] 异步处理耗时任务
- [x] 支持取消操作
- [x] 错误处理完善
- [x] 资源清理机制
- [ ] 单元测试覆盖
- [ ] 日志记录机制

### B. 修订历史

| 版本 | 日期 | 说明 |
|------|------|------|
| 1.0 | 2026-01-18 | 初始版本 |

---

*文档结束*
