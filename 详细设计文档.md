# 视频压缩工具 - 详细设计文档 (DDD)

**版本**: 1.0
**日期**: 2026-01-18
**项目名称**: Video Compressor (视频压缩工具)

---

## 1. 文档概述

### 1.1 目的
本文档详细描述视频压缩工具各模块的内部设计，包括类结构、方法定义、算法逻辑和数据结构，为编码实现提供详细指导。

### 1.2 参考文档
- 软件需求规格说明书 v1.0
- 软件架构设计文档 v1.0

---

## 2. 模块详细设计

### 2.1 程序入口模块 (main.py)

#### 2.1.1 模块职责
- 初始化运行环境
- 配置高 DPI 支持
- 设置 FFmpeg 路径
- 启动 Qt 应用程序

#### 2.1.2 流程图

```
开始
  │
  ▼
┌─────────────────────┐
│ 添加项目根目录到PATH │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│ 检查并添加 FFmpeg   │
│ 路径到 PATH         │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│ 设置 Windows DPI    │
│ 感知模式            │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│ 设置 Qt 高DPI       │
│ 环境变量            │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│ 创建 QApplication   │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│ 设置应用样式和字体   │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│ 创建并显示 MainWindow│
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│ 进入 Qt 事件循环    │
│ app.exec_()         │
└──────────┬──────────┘
           │
           ▼
         结束
```

#### 2.1.3 关键代码片段

```python
# 高 DPI 设置 (Windows)
if sys.platform == 'win32':
    import ctypes
    ctypes.windll.shcore.SetProcessDpiAwareness(2)  # PROCESS_PER_MONITOR_DPI_AWARE

# Qt 高 DPI 属性
QCoreApplication.setAttribute(Qt.AA_EnableHighDpiScaling, True)
QCoreApplication.setAttribute(Qt.AA_UseHighDpiPixmaps, True)

# FFmpeg 路径注入
ffmpeg_path = os.path.join(os.path.dirname(__file__), "ffmpeg-.../bin")
if os.path.exists(ffmpeg_path):
    os.environ["PATH"] = ffmpeg_path + os.pathsep + os.environ["PATH"]
```

---

### 2.2 核心业务模块 (core/)

#### 2.2.1 presets.py - 预设配置模块

##### 类图

```
┌─────────────────────────────────┐
│         <<enumeration>>         │
│          QualityLevel           │
├─────────────────────────────────┤
│ HIGH = "high"                   │
│ MEDIUM = "medium"               │
│ LOW = "low"                     │
└─────────────────────────────────┘

┌─────────────────────────────────┐
│         <<enumeration>>         │
│          VideoCodec             │
├─────────────────────────────────┤
│ H264 = "libx264"                │
│ H265 = "libx265"                │
└─────────────────────────────────┘

┌─────────────────────────────────┐
│         <<enumeration>>         │
│          Resolution             │
├─────────────────────────────────┤
│ ORIGINAL = "original"           │
│ P720 = "720p"                   │
│ P1080 = "1080p"                 │
│ P480 = "480p"                   │
│ CUSTOM = "custom"               │
└─────────────────────────────────┘

┌─────────────────────────────────┐
│         <<enumeration>>         │
│          FrameRate              │
├─────────────────────────────────┤
│ ORIGINAL = "original"           │
│ FPS_24 = 24                     │
│ FPS_30 = 30                     │
│ FPS_60 = 60                     │
└─────────────────────────────────┘

┌─────────────────────────────────┐
│         <<enumeration>>         │
│        CompressionMode          │
├─────────────────────────────────┤
│ QUALITY = "quality"             │
│ RATIO = "ratio"                 │
│ TARGET_SIZE = "target_size"     │
└─────────────────────────────────┘

┌─────────────────────────────────────────────┐
│           <<dataclass>>                      │
│        CompressionSettings                   │
├─────────────────────────────────────────────┤
│ + quality_level: QualityLevel = MEDIUM      │
│ + video_codec: VideoCodec = H264            │
│ + video_bitrate: Optional[int] = None       │
│ + resolution: Resolution = ORIGINAL         │
│ + custom_width: Optional[int] = None        │
│ + custom_height: Optional[int] = None       │
│ + frame_rate: FrameRate = ORIGINAL          │
│ + custom_fps: Optional[int] = None          │
│ + audio_bitrate: int = 192                  │
│ + keep_audio: bool = True                   │
│ + use_advanced: bool = False                │
│ + compression_mode: CompressionMode = QUALITY│
│ + target_ratio: int = 50                    │
│ + target_size_mb: float = 0                 │
└─────────────────────────────────────────────┘
```

##### 常量定义

```python
QUALITY_PRESETS = {
    QualityLevel.HIGH: {
        'crf': 18,
        'preset': 'slow',
        'description': '高质量 - 视觉无损，适合存档',
        'estimated_ratio': '30-50%',
    },
    QualityLevel.MEDIUM: {
        'crf': 23,
        'preset': 'medium',
        'description': '中等质量 - 平衡质量与大小',
        'estimated_ratio': '50-70%',
    },
    QualityLevel.LOW: {
        'crf': 28,
        'preset': 'fast',
        'description': '低质量 - 最小体积，适合分享',
        'estimated_ratio': '70-90%',
    },
}

RESOLUTION_MAP = {
    Resolution.P720: (1280, 720),
    Resolution.P1080: (1920, 1080),
    Resolution.P480: (854, 480),
}

AUDIO_BITRATE_OPTIONS = [64, 128, 192, 256, 320]
```

##### 核心函数

**get_crf_for_codec(quality, codec) → int**
```
功能: 根据编码器调整 CRF 值
逻辑: H.265 的 CRF 比 H.264 低 4 可获得相似质量

伪代码:
    base_crf = QUALITY_PRESETS[quality]['crf']
    if codec == H265:
        return base_crf - 4
    return base_crf
```

**calculate_target_resolution(original_width, original_height, target, custom_w, custom_h) → tuple**
```
功能: 计算目标分辨率，保持宽高比，不放大
逻辑:
    1. 如果保持原始，返回原始尺寸
    2. 如果自定义，返回自定义尺寸
    3. 计算缩放比例，取较小值
    4. 确保宽高为偶数（编码器要求）

伪代码:
    if target == ORIGINAL:
        return (original_width, original_height)
    if target == CUSTOM:
        return (custom_w, custom_h)

    target_w, target_h = RESOLUTION_MAP[target]

    # 不放大
    if original <= target:
        return original

    scale = min(target_w/original_w, target_h/original_h)
    new_w = int(original_w * scale) - (new_w % 2)  # 保证偶数
    new_h = int(original_h * scale) - (new_h % 2)
    return (new_w, new_h)
```

**calculate_target_bitrate(target_size_bytes, duration_seconds, audio_bitrate, keep_audio) → int**
```
功能: 根据目标文件大小计算视频码率
公式:
    total_bits = target_size_bytes * 8
    audio_bits = audio_bitrate * 1000 * duration (如果保留音频)
    video_bits = total_bits - audio_bits
    video_bitrate = video_bits / duration / 1000

约束:
    - 最小码率: 200 kbps
    - 最大码率: 50000 kbps
```

**get_ffmpeg_params(settings, video_info) → dict**
```
功能: 根据设置生成 FFmpeg 参数字典
返回示例:
    {
        'video_codec': 'libx264',
        'crf': 23,
        'preset': 'medium',
        'audio_codec': 'aac',
        'audio_bitrate': '192k',
        'scale': '1280:720',  # 可选
        'fps': 30,            # 可选
    }
```

---

#### 2.2.2 utils.py - 工具函数模块

##### 函数列表

| 函数 | 参数 | 返回值 | 功能 |
|------|------|--------|------|
| format_size | size_bytes: int | str | 格式化文件大小 |
| format_duration | seconds: float | str | 格式化时长 |
| parse_duration | duration_str: str | float | 解析时长字符串 |
| get_video_info | file_path: str | dict/None | 获取视频信息 |
| check_ffmpeg_installed | - | bool | 检查 FFmpeg 安装 |
| get_supported_formats | - | list | 获取支持的格式 |
| is_supported_format | file_path: str | bool | 检查格式支持 |
| get_output_path | input_path, output_dir, suffix | str | 生成输出路径 |
| ensure_unique_path | file_path: str | str | 确保路径唯一 |
| calculate_compression_ratio | original, compressed | float | 计算压缩率 |

##### format_size 算法

```python
def format_size(size_bytes: int) -> str:
    """
    算法: 逐级除以 1024，选择合适单位

    示例:
        1024 → "1.00 KB"
        1048576 → "1.00 MB"
        1073741824 → "1.00 GB"
    """
    units = ['B', 'KB', 'MB', 'GB', 'TB']
    unit_index = 0
    size = float(size_bytes)

    while size >= 1024 and unit_index < len(units) - 1:
        size /= 1024
        unit_index += 1

    if unit_index == 0:
        return f"{int(size)} {units[unit_index]}"
    return f"{size:.2f} {units[unit_index]}"
```

##### get_video_info 流程

```
输入: file_path
  │
  ▼
┌─────────────────────┐
│ 检查文件是否存在     │
└──────────┬──────────┘
           │ 存在
           ▼
┌─────────────────────┐
│ 调用 ffprobe        │
│ -print_format json  │
│ -show_format        │
│ -show_streams       │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│ 解析 JSON 输出      │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│ 提取视频流信息       │
│ 提取音频流信息       │
│ 提取格式信息        │
└──────────┬──────────┘
           │
           ▼
返回 info 字典
```

##### 返回的 info 字典结构

```python
{
    'file_path': str,       # 完整路径
    'file_name': str,       # 文件名
    'file_size': int,       # 字节数
    'duration': float,      # 秒数
    'bit_rate': int,        # 总码率
    'format_name': str,     # 格式名

    # 视频信息 (如果有视频流)
    'width': int,
    'height': int,
    'video_codec': str,
    'video_bit_rate': int,
    'fps': float,

    # 音频信息 (如果有音频流)
    'audio_codec': str,
    'audio_bit_rate': int,
    'sample_rate': int,
    'channels': int,
}
```

---

#### 2.2.3 compressor.py - 压缩器模块

##### 类图

```
┌─────────────────────────────────────────────────────────────┐
│                     <<dataclass>>                            │
│                   CompressionResult                          │
├─────────────────────────────────────────────────────────────┤
│ + success: bool                                              │
│ + input_path: str                                            │
│ + output_path: str                                           │
│ + original_size: int = 0                                     │
│ + compressed_size: int = 0                                   │
│ + error_message: str = ""                                    │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                      VideoCompressor                         │
│                       (QObject)                              │
├─────────────────────────────────────────────────────────────┤
│ <<signals>>                                                  │
│ + progress_updated: pyqtSignal(float)                       │
│ + status_updated: pyqtSignal(str)                           │
│ + compression_finished: pyqtSignal(CompressionResult)       │
│ + compression_error: pyqtSignal(str)                        │
├─────────────────────────────────────────────────────────────┤
│ - _process: Optional[subprocess.Popen]                      │
│ - _is_cancelled: bool                                        │
│ - _is_paused: bool                                           │
│ - _pause_event: threading.Event                              │
├─────────────────────────────────────────────────────────────┤
│ + compress(input_path, output_path, settings): void         │
│ + cancel(): void                                             │
│ + pause(): void                                              │
│ + resume(): void                                             │
│ + is_paused: bool <<property>>                              │
│ + is_cancelled: bool <<property>>                           │
├─────────────────────────────────────────────────────────────┤
│ - _compress_thread(input_path, output_path, settings): void │
│ - _build_ffmpeg_command(input, output, settings, info): list│
│ - _parse_progress(total_duration): void                     │
└─────────────────────────────────────────────────────────────┘
                              │
                              │ 使用
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                      BatchCompressor                         │
│                       (QObject)                              │
├─────────────────────────────────────────────────────────────┤
│ <<signals>>                                                  │
│ + file_started: pyqtSignal(int, str)                        │
│ + file_progress: pyqtSignal(int, float)                     │
│ + file_finished: pyqtSignal(int, CompressionResult)         │
│ + batch_finished: pyqtSignal(list)                          │
│ + batch_cancelled: pyqtSignal()                             │
├─────────────────────────────────────────────────────────────┤
│ - _compressor: VideoCompressor                               │
│ - _current_index: int                                        │
│ - _files: list                                               │
│ - _output_dir: str                                           │
│ - _settings: CompressionSettings                             │
│ - _results: list                                             │
│ - _is_running: bool                                          │
├─────────────────────────────────────────────────────────────┤
│ + start_batch(files, output_dir, settings, suffix): void    │
│ + cancel(): void                                             │
│ + pause(): void                                              │
│ + resume(): void                                             │
│ + is_running: bool <<property>>                             │
│ + current_index: int <<property>>                           │
│ + total_files: int <<property>>                             │
├─────────────────────────────────────────────────────────────┤
│ - _compress_next(): void                                     │
│ - _on_progress(progress): void                               │
│ - _on_file_finished(result): void                           │
│ - _on_error(error): void                                     │
└─────────────────────────────────────────────────────────────┘
```

##### VideoCompressor.compress() 序列图

```
MainWindow      VideoCompressor     Thread          FFmpeg
    │                 │               │               │
    │ compress()      │               │               │
    │────────────────►│               │               │
    │                 │ 创建线程       │               │
    │                 │──────────────►│               │
    │                 │               │               │
    │                 │               │ get_video_info│
    │                 │               │──────────────►│
    │                 │               │◄──────────────│
    │                 │               │               │
    │                 │               │ 构建命令      │
    │                 │               │               │
    │                 │               │ Popen()       │
    │                 │               │──────────────►│
    │                 │               │               │
    │◄─ status_updated("正在压缩...") │               │
    │                 │               │               │
    │                 │               │ 读取 stdout   │
    │                 │               │◄──────────────│
    │◄─ progress_updated(30.5)        │               │
    │                 │               │               │
    │◄─ progress_updated(60.2)        │               │
    │                 │               │               │
    │                 │               │ wait()        │
    │                 │               │──────────────►│
    │                 │               │◄──────────────│
    │                 │               │               │
    │◄─ compression_finished(result)  │               │
    │                 │               │               │
```

##### _build_ffmpeg_command() 构建逻辑

```python
def _build_ffmpeg_command(self, input_path, output_path, settings, video_info):
    """
    构建 FFmpeg 命令列表

    基础命令:
        ffmpeg -y -i {input}

    视频参数:
        -c:v {codec}          # 编码器
        -crf {value}          # 质量因子 (CRF模式)
        -b:v {bitrate}        # 码率 (码率模式)
        -preset {speed}       # 编码速度
        -vf scale={w}:{h}     # 缩放 (如需要)
        -r {fps}              # 帧率 (如需要)

    音频参数:
        -c:a aac              # 音频编码器
        -b:a {bitrate}        # 音频码率
        或
        -an                   # 移除音频

    H.265 特殊:
        -tag:v hvc1           # 兼容性标签

    输出:
        {output_path}
    """
    cmd = ['ffmpeg', '-y', '-i', input_path]

    params = get_ffmpeg_params(settings, video_info)

    # 视频编码器
    cmd.extend(['-c:v', params['video_codec']])

    # CRF 或 码率
    if 'crf' in params:
        cmd.extend(['-crf', str(params['crf'])])
    if 'video_bitrate' in params:
        cmd.extend(['-b:v', params['video_bitrate']])

    # 预设
    if 'preset' in params:
        cmd.extend(['-preset', params['preset']])

    # 分辨率
    if 'scale' in params:
        cmd.extend(['-vf', f"scale={params['scale']}"])

    # 帧率
    if 'fps' in params:
        cmd.extend(['-r', str(params['fps'])])

    # 音频
    if params.get('no_audio'):
        cmd.append('-an')
    else:
        if 'audio_codec' in params:
            cmd.extend(['-c:a', params['audio_codec']])
        if 'audio_bitrate' in params:
            cmd.extend(['-b:a', params['audio_bitrate']])

    # H.265 兼容性
    if params['video_codec'] == 'libx265':
        cmd.extend(['-tag:v', 'hvc1'])

    cmd.append(output_path)
    return cmd
```

##### _parse_progress() 进度解析

```
FFmpeg 输出格式:
    frame=  100 fps=30 q=28.0 size=    1024kB time=00:00:03.33 bitrate=2515.2kbits/s

解析逻辑:
    正则表达式: r'time=(\d+:\d+:\d+\.?\d*)'

    提取 time 值 → 解析为秒数 → 计算进度百分比

    progress = (current_time / total_duration) * 100
```

```python
def _parse_progress(self, total_duration: float):
    time_pattern = re.compile(r'time=(\d+:\d+:\d+\.?\d*)')

    for line in iter(self._process.stdout.readline, ''):
        if self._is_cancelled:
            break

        self._pause_event.wait()  # 暂停检查

        match = time_pattern.search(line)
        if match and total_duration > 0:
            current_time = parse_duration(match.group(1))
            progress = min(100, (current_time / total_duration) * 100)
            self.progress_updated.emit(progress)
```

##### BatchCompressor 状态机

```
            ┌─────────┐
            │  IDLE   │ ◄─────────────────────────────────┐
            └────┬────┘                                    │
                 │ start_batch()                          │
                 ▼                                         │
            ┌─────────┐                                    │
     ┌─────►│ RUNNING │                                    │
     │      └────┬────┘                                    │
     │           │                                         │
     │      ┌────┴────┐                                    │
     │      │         │                                    │
     │      ▼         ▼                                    │
     │ 文件完成   最后文件完成                              │
     │      │         │                                    │
     │      │         ▼                                    │
     │      │    ┌─────────┐    batch_finished             │
     └──────┘    │ FINISHED│ ──────────────────────────────┘
                 └─────────┘
                      ▲
                      │ cancel()
            ┌─────────┐
            │CANCELLED│
            └─────────┘
```

---

### 2.3 用户界面模块 (ui/)

#### 2.3.1 file_list.py - 文件列表模块

##### 类图

```
┌───────────────────────────────────────────────────────────┐
│                        DropZone                           │
│                        (QFrame)                           │
├───────────────────────────────────────────────────────────┤
│ <<signals>>                                               │
│ + files_dropped: pyqtSignal(list)                        │
├───────────────────────────────────────────────────────────┤
│ + select_btn: QPushButton                                 │
├───────────────────────────────────────────────────────────┤
│ + dragEnterEvent(event: QDragEnterEvent): void           │
│ + dragLeaveEvent(event): void                             │
│ + dropEvent(event: QDropEvent): void                      │
│ - _setup_ui(): void                                       │
│ - _on_select_clicked(): void                              │
└───────────────────────────────────────────────────────────┘

┌───────────────────────────────────────────────────────────┐
│                     FileListWidget                        │
│                       (QWidget)                           │
├───────────────────────────────────────────────────────────┤
│ <<signals>>                                               │
│ + files_changed: pyqtSignal()                            │
├───────────────────────────────────────────────────────────┤
│ <<constants>>                                             │
│ + COL_NAME = 0                                            │
│ + COL_SIZE = 1                                            │
│ + COL_DURATION = 2                                        │
│ + COL_STATUS = 3                                          │
├───────────────────────────────────────────────────────────┤
│ - _files: List[dict]                                      │
│ + drop_zone: DropZone                                     │
│ + table: QTableWidget                                     │
│ + clear_btn: QPushButton                                  │
├───────────────────────────────────────────────────────────┤
│ + add_files(file_paths: List[str]): void                 │
│ + remove_selected(): void                                 │
│ + clear_files(): void                                     │
│ + update_status(index: int, status: str): void           │
│ + get_files(): List[str]                                 │
│ + get_file_info(index: int): Optional[dict]              │
│ + file_count(): int                                       │
│ + has_files(): bool                                       │
├───────────────────────────────────────────────────────────┤
│ - _setup_ui(): void                                       │
│ - _add_table_row(file_data: dict): void                  │
│ - _table_key_press(event): void                          │
│ - _show_context_menu(pos): void                          │
└───────────────────────────────────────────────────────────┘
```

##### 文件数据结构

```python
file_data = {
    'path': str,       # 完整文件路径
    'name': str,       # 文件名
    'size': int,       # 文件大小 (bytes)
    'duration': float, # 时长 (秒)
    'status': str,     # 状态 ("等待中", "压缩中", "完成", "失败")
    'info': dict,      # 完整视频信息 (from get_video_info)
}
```

##### add_files() 流程

```
输入: file_paths (文件路径列表)
  │
  ▼
┌─────────────────────┐
│ 遍历每个文件路径     │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│ 检查是否已在列表中   │──── 是 ────► 跳过
└──────────┬──────────┘
           │ 否
           ▼
┌─────────────────────┐
│ 调用 get_video_info │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│ 信息获取失败?       │──── 是 ────► 跳过
└──────────┬──────────┘
           │ 否
           ▼
┌─────────────────────┐
│ 创建 file_data 字典 │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│ 添加到 _files 列表  │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│ 添加表格行          │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│ 发射 files_changed  │
└─────────────────────┘
```

##### 拖拽处理流程

```
dragEnterEvent                 dropEvent
      │                             │
      ▼                             ▼
┌────────────────┐          ┌────────────────┐
│ 检查 hasUrls() │          │ 恢复正常样式    │
└───────┬────────┘          └───────┬────────┘
        │ 是                        │
        ▼                           ▼
┌────────────────┐          ┌────────────────┐
│ 接受拖放       │          │ 遍历 URLs      │
│ 设置高亮样式   │          └───────┬────────┘
└────────────────┘                  │
                                    ▼
                           ┌────────────────┐
                           │ 检查是否为      │
                           │ 支持的视频格式  │
                           └───────┬────────┘
                                   │ 是
                                   ▼
                           ┌────────────────┐
                           │ 发射           │
                           │ files_dropped  │
                           └────────────────┘
```

---

#### 2.3.2 settings.py - 设置面板模块

##### 类图

```
┌─────────────────────────────────────────────────────────────┐
│                       SettingsPanel                          │
│                        (QWidget)                             │
├─────────────────────────────────────────────────────────────┤
│ <<signals>>                                                  │
│ + settings_changed: pyqtSignal()                            │
├─────────────────────────────────────────────────────────────┤
│ # 质量等级                                                   │
│ + quality_group: QButtonGroup                                │
│ + quality_high: QRadioButton                                 │
│ + quality_medium: QRadioButton                               │
│ + quality_low: QRadioButton                                  │
│                                                              │
│ # 压缩模式                                                   │
│ + mode_group: QButtonGroup                                   │
│ + mode_quality: QRadioButton                                 │
│ + mode_ratio: QRadioButton                                   │
│ + mode_size: QRadioButton                                    │
│ + ratio_spin: QSpinBox                                       │
│ + size_spin: QSpinBox                                        │
│                                                              │
│ # 高级选项                                                   │
│ + advanced_btn: QPushButton                                  │
│ + advanced_panel: QFrame                                     │
│ + bitrate_combo: QComboBox                                   │
│ + custom_bitrate: QSpinBox                                   │
│ + resolution_combo: QComboBox                                │
│ + custom_width: QSpinBox                                     │
│ + custom_height: QSpinBox                                    │
│ + codec_combo: QComboBox                                     │
│ + fps_combo: QComboBox                                       │
│ + custom_fps: QSpinBox                                       │
│ + audio_bitrate_combo: QComboBox                            │
│ + keep_audio_check: QCheckBox                                │
│                                                              │
│ # 输出设置                                                   │
│ + output_dir_edit: QLineEdit                                 │
│ + browse_btn: QPushButton                                    │
│ + suffix_edit: QLineEdit                                     │
│ + open_folder_check: QCheckBox                               │
│ + play_sound_check: QCheckBox                                │
├─────────────────────────────────────────────────────────────┤
│ + get_settings(): CompressionSettings                        │
│ + get_output_dir(): str                                      │
│ + get_suffix(): str                                          │
│ + should_open_folder(): bool                                 │
│ + should_play_sound(): bool                                  │
│ + set_enabled(enabled: bool): void                          │
├─────────────────────────────────────────────────────────────┤
│ - _setup_ui(): void                                          │
│ - _connect_signals(): void                                   │
│ - _toggle_advanced(): void                                   │
│ - _on_mode_changed(): void                                   │
│ - _on_bitrate_changed(index): void                          │
│ - _on_resolution_changed(index): void                       │
│ - _on_fps_changed(index): void                              │
│ - _browse_output_dir(): void                                │
└─────────────────────────────────────────────────────────────┘
```

##### get_settings() 逻辑

```python
def get_settings(self) -> CompressionSettings:
    settings = CompressionSettings()

    # 1. 质量等级映射
    quality_id = self.quality_group.checkedId()  # 0=高, 1=中, 2=低
    quality_map = {0: QualityLevel.HIGH, 1: QualityLevel.MEDIUM, 2: QualityLevel.LOW}
    settings.quality_level = quality_map[quality_id]

    # 2. 压缩模式映射
    mode_id = self.mode_group.checkedId()  # 0=质量, 1=比例, 2=大小
    mode_map = {0: CompressionMode.QUALITY, 1: CompressionMode.RATIO, 2: CompressionMode.TARGET_SIZE}
    settings.compression_mode = mode_map[mode_id]
    settings.target_ratio = self.ratio_spin.value()
    settings.target_size_mb = self.size_spin.value()

    # 3. 高级模式设置
    settings.use_advanced = self.advanced_btn.isChecked()

    if settings.use_advanced:
        # 码率
        bitrate_index = self.bitrate_combo.currentIndex()
        if bitrate_index == 0:  # 自动
            settings.video_bitrate = None
        elif bitrate_index == count - 1:  # 自定义
            settings.video_bitrate = self.custom_bitrate.value()
        else:  # 预设值
            settings.video_bitrate = parse_bitrate(self.bitrate_combo.currentText())

        # 分辨率
        res_index = self.resolution_combo.currentIndex()
        res_map = {0: Resolution.ORIGINAL, 1: Resolution.P1080, ...}
        settings.resolution = res_map[res_index]

        # 编码器
        codec_map = {0: VideoCodec.H264, 1: VideoCodec.H265}
        settings.video_codec = codec_map[self.codec_combo.currentIndex()]

        # 帧率
        # ... 类似逻辑

        # 音频
        settings.audio_bitrate = AUDIO_BITRATE_OPTIONS[self.audio_bitrate_combo.currentIndex()]
        settings.keep_audio = self.keep_audio_check.isChecked()

    return settings
```

---

#### 2.3.3 main_window.py - 主窗口模块

##### 类图

```
┌─────────────────────────────────────────────────────────────┐
│                        MainWindow                            │
│                      (QMainWindow)                           │
├─────────────────────────────────────────────────────────────┤
│ - _batch_compressor: BatchCompressor                        │
│ - _is_compressing: bool                                      │
├─────────────────────────────────────────────────────────────┤
│ # UI 组件                                                    │
│ + file_list: FileListWidget                                  │
│ + settings_panel: SettingsPanel                              │
│ + current_file_label: QLabel                                 │
│ + file_progress: QProgressBar                                │
│ + total_progress_label: QLabel                               │
│ + start_btn: QPushButton                                     │
│ + cancel_btn: QPushButton                                    │
├─────────────────────────────────────────────────────────────┤
│ + closeEvent(event): void                                    │
├─────────────────────────────────────────────────────────────┤
│ - _setup_ui(): void                                          │
│ - _connect_signals(): void                                   │
│ - _check_ffmpeg(): void                                      │
│ - _update_start_button(): void                               │
│ - _start_compression(): void                                 │
│ - _cancel_compression(): void                                │
│ - _on_file_started(index, file_name): void                  │
│ - _on_file_progress(index, progress): void                  │
│ - _on_file_finished(index, result): void                    │
│ - _on_batch_finished(results): void                         │
│ - _on_batch_cancelled(): void                               │
└─────────────────────────────────────────────────────────────┘
```

##### 信号连接表

| 信号来源 | 信号 | 槽函数 |
|----------|------|--------|
| start_btn | clicked | _start_compression |
| cancel_btn | clicked | _cancel_compression |
| file_list | files_changed | _update_start_button |
| _batch_compressor | file_started | _on_file_started |
| _batch_compressor | file_progress | _on_file_progress |
| _batch_compressor | file_finished | _on_file_finished |
| _batch_compressor | batch_finished | _on_batch_finished |
| _batch_compressor | batch_cancelled | _on_batch_cancelled |

##### _start_compression() 流程

```
开始
  │
  ▼
┌─────────────────────┐
│ 检查是否有文件       │──── 无 ────► 显示提示，返回
└──────────┬──────────┘
           │ 有
           ▼
┌─────────────────────┐
│ 获取输出目录        │──── 空 ────► 显示警告，返回
└──────────┬──────────┘
           │ 有效
           ▼
┌─────────────────────┐
│ 创建输出目录        │──── 失败 ──► 显示错误，返回
└──────────┬──────────┘
           │ 成功
           ▼
┌─────────────────────┐
│ 获取压缩设置        │
│ 获取文件列表        │
│ 获取文件后缀        │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│ 更新 UI 状态:       │
│ - _is_compressing=True│
│ - 禁用开始按钮      │
│ - 启用取消按钮      │
│ - 禁用设置面板      │
│ - 重置进度条        │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│ 重置所有文件状态    │
│ 为"等待中"          │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│ 调用                │
│ start_batch(...)    │
└─────────────────────┘
```

##### _on_batch_finished() 流程

```
输入: results (CompressionResult 列表)
  │
  ▼
┌─────────────────────┐
│ 恢复 UI 状态:       │
│ - _is_compressing=False│
│ - 启用开始按钮      │
│ - 禁用取消按钮      │
│ - 启用设置面板      │
│ - 更新状态标签      │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│ 统计结果:           │
│ - 成功数量          │
│ - 总原始大小        │
│ - 总压缩后大小      │
│ - 计算压缩率        │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│ 显示结果对话框      │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│ 播放提示音?         │──── 是 ────► winsound.MessageBeep()
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│ 打开输出目录?       │──── 是 ────► os.startfile(output_dir)
└─────────────────────┘
```

---

## 3. 算法设计

### 3.1 压缩率计算算法

```python
def calculate_compression_ratio(original_size: int, compressed_size: int) -> float:
    """
    计算压缩率（节省百分比）

    公式: (1 - compressed_size / original_size) * 100

    示例:
        原始: 100MB, 压缩后: 30MB
        压缩率 = (1 - 30/100) * 100 = 70%
        表示节省了 70% 的空间
    """
    if original_size <= 0:
        return 0
    return (1 - compressed_size / original_size) * 100
```

### 3.2 目标码率计算算法

```python
def calculate_target_bitrate(target_size_bytes, duration_seconds,
                              audio_bitrate_kbps, keep_audio):
    """
    根据目标文件大小反推视频码率

    公式:
        total_bits = target_size * 8
        audio_bits = audio_bitrate * 1000 * duration
        video_bits = total_bits - audio_bits
        video_bitrate = video_bits / duration / 1000

    示例:
        目标大小: 50MB = 50 * 1024 * 1024 = 52428800 bytes
        时长: 120 秒
        音频码率: 192 kbps

        total_bits = 52428800 * 8 = 419430400 bits
        audio_bits = 192 * 1000 * 120 = 23040000 bits
        video_bits = 419430400 - 23040000 = 396390400 bits
        video_bitrate = 396390400 / 120 / 1000 = 3303 kbps
    """
```

### 3.3 分辨率缩放算法

```python
def calculate_target_resolution(original_w, original_h, target_w, target_h):
    """
    保持宽高比的缩放算法

    规则:
        1. 不放大（如果原始小于目标，保持原始）
        2. 选择较小的缩放比例以保持宽高比
        3. 结果宽高必须为偶数（编码器要求）

    示例:
        原始: 3840x2160 (4K)
        目标: 1920x1080 (1080p)

        scale_w = 1920 / 3840 = 0.5
        scale_h = 1080 / 2160 = 0.5
        scale = min(0.5, 0.5) = 0.5

        new_w = 3840 * 0.5 = 1920
        new_h = 2160 * 0.5 = 1080
    """
```

### 3.4 进度解析算法

```python
def parse_ffmpeg_progress(stdout_line, total_duration):
    """
    从 FFmpeg 输出解析进度

    FFmpeg 输出示例:
        frame=  150 fps=30 q=23.0 size=    2048kB time=00:00:05.00 ...

    解析步骤:
        1. 使用正则提取 time 值: time=00:00:05.00
        2. 解析为秒数: 5.0
        3. 计算百分比: 5.0 / total_duration * 100
    """
    pattern = r'time=(\d+:\d+:\d+\.?\d*)'
    match = re.search(pattern, stdout_line)
    if match:
        current_time = parse_time_to_seconds(match.group(1))
        progress = min(100, (current_time / total_duration) * 100)
        return progress
    return None
```

---

## 4. 错误处理设计

### 4.1 错误类型与处理

| 错误场景 | 检测方式 | 处理方式 | 用户提示 |
|----------|----------|----------|----------|
| FFmpeg 未安装 | check_ffmpeg_installed() | 启动时检查 | 弹窗警告 |
| 文件格式不支持 | is_supported_format() | 拖入时过滤 | 静默忽略 |
| 无法获取视频信息 | get_video_info() 返回 None | 添加时跳过 | 静默忽略 |
| 输出目录不存在 | os.path.exists() | 尝试创建 | 创建失败弹窗 |
| FFmpeg 执行失败 | returncode != 0 | 标记失败，继续下一个 | 状态显示"失败" |
| 压缩过程异常 | try-except | 发射 error 信号 | 状态显示错误信息 |

### 4.2 错误处理代码示例

```python
# VideoCompressor._compress_thread
try:
    video_info = get_video_info(input_path)
    if not video_info:
        self.compression_error.emit(f"无法获取视频信息: {input_path}")
        return

    # ... 压缩逻辑 ...

    if self._process.returncode != 0:
        result = CompressionResult(
            success=False,
            input_path=input_path,
            output_path=output_path,
            error_message="FFmpeg 返回错误"
        )
        self.compression_finished.emit(result)

except Exception as e:
    self.compression_error.emit(str(e))
```

---

## 5. 界面布局设计

### 5.1 主窗口布局

```
┌─────────────────────────────────────────────────────────────┐
│ 视频压缩工具                                                │ ← 标题
├─────────────────────────────────────────────────────────────┤
│ ┌─────────────────────────────────────────────────────────┐ │
│ │              📁                                          │ │
│ │      拖拽视频文件到此处 或 点击选择文件                   │ │ ← DropZone
│ │      支持 MP4, MOV, AVI, MKV, WMV, FLV, WEBM, M4V       │ │   (120px高)
│ │              [ 选择文件 ]                                │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                              │
│ 文件列表:                                    [ 清空列表 ]    │
│ ┌──────────────┬──────────┬──────────┬──────────┐          │
│ │ 文件名       │ 大小     │ 时长     │ 状态     │          │ ← FileListWidget
│ ├──────────────┼──────────┼──────────┼──────────┤          │
│ │ video1.mp4   │ 1.5 GB   │ 02:30:00 │ 等待中   │          │
│ │ video2.mov   │ 800 MB   │ 00:45:00 │ 等待中   │          │
│ └──────────────┴──────────┴──────────┴──────────┘          │
├─────────────────────────────────────────────────────────────┤
│ ┌─ 压缩设置 ───────────────────────────────────────────────┐│
│ │ 质量等级: ○ 高质量  ● 中等质量  ○ 低质量                 ││ ← SettingsPanel
│ │ 压缩模式: ● 按质量  ○ 按比例    ○ 按大小                 ││
│ │ ▶ 高级选项                                               ││
│ └─────────────────────────────────────────────────────────┘│
│ ┌─ 输出设置 ───────────────────────────────────────────────┐│
│ │ 输出目录: [~/Videos/Compressed              ] [浏览...]  ││
│ │ 文件后缀: [_compressed]                                  ││
│ └─────────────────────────────────────────────────────────┘│
│ ┌─ 完成后操作 ─────────────────────────────────────────────┐│
│ │ ☑ 打开输出目录    ☐ 播放提示音                          ││
│ └─────────────────────────────────────────────────────────┘│
├─────────────────────────────────────────────────────────────┤
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ 正在压缩: video1.mp4                                    │ │ ← 进度区域
│ │ ████████████░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░ 35%    │ │
│ │ 总进度: 1/5                                             │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                              │
│                [ 开始压缩 ]    [ 取消 ]                      │ ← 按钮区域
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

### 5.2 高级选项展开布局

```
┌─ 高级选项 (展开) ───────────────────────────────────────────┐
│                                                              │
│ 视频码率: [自动      ▼] [4000 kbps]   分辨率: [保持原始 ▼]  │
│                                                              │
│ 编码器:   [H.264     ▼]               帧率:   [保持原始 ▼]  │
│                                                              │
│ 音频码率: [192 kbps  ▼]               ☑ 保留音频             │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

---

## 6. 附录

### A. FFmpeg 命令示例

```bash
# 高质量压缩 (CRF 18)
ffmpeg -y -i input.mp4 -c:v libx264 -crf 18 -preset slow -c:a aac -b:a 192k output.mp4

# 中等质量 + 720p 缩放
ffmpeg -y -i input.mp4 -c:v libx264 -crf 23 -preset medium -vf scale=1280:720 -c:a aac -b:a 192k output.mp4

# H.265 编码
ffmpeg -y -i input.mp4 -c:v libx265 -crf 19 -preset medium -tag:v hvc1 -c:a aac -b:a 192k output.mp4

# 指定目标码率 (按大小模式)
ffmpeg -y -i input.mp4 -c:v libx264 -b:v 2000k -preset medium -c:a aac -b:a 192k output.mp4

# 移除音频
ffmpeg -y -i input.mp4 -c:v libx264 -crf 23 -preset medium -an output.mp4
```

### B. 修订历史

| 版本 | 日期 | 说明 |
|------|------|------|
| 1.0 | 2026-01-18 | 初始版本 |

---

*文档结束*
